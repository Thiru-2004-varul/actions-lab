name: Deploy

on:
  workflow_run:
    workflows: ["Build"]
    types:
      - completed

permissions:
  actions: write
  contents: write
  pull-requests: write

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: dist

      - name: Verify artifact
        run: |
          ls -R dist
          cat dist/build.txt

      - name: Deploy (simulation)
        run: |
          echo "ðŸš€ Deploying artifact..."

      - name: Label Feature PRs
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.workflow_run.head_branch;
            const prs = context.payload.workflow_run.pull_requests;
            
            if (prs.length > 0 && branch.includes("feature")) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prs[0].number,
                labels: ["feature"]
              });
            }

      - name: Tag Release
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const tag = `release-${date}`;
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tag}`,
                sha: context.payload.workflow_run.head_sha
              });
              console.log(`Created release tag:${tag}`);
            } catch (e) {
              console.log(`Tag ${tag} might already exist or error occurred:${e.message}`);
            }
